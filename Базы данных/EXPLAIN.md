# EXPLAIN

Explain - Это команда sql, которая показывает как планируется выполнение запрос. Она его не выполняет, а только сторит план выполнения и собирает статистику. Есть также EXPLAIN ANALYZE который реально выполняет запрос и собирает статистику.

## Основные цели EXPLAIN

1. Понять какие чатси запроса тормозят
2. Увидеть используется ли индексы
3. Найти полные сканы таблиц
4. Найти лишние соединения или неоптимальные запросы
5. выявить узкие места при сложных запросах

Пример
`Seq Scan on orders(cost=0.00..431.0) rows=1000 width=48 Filter: (customer_id=5)`

Seq Scan - последовательное сканирование всей таблицы
cost=0.00..431.0 - предположительные затраты(чем больше вторая цифра тем тяжелее)
rows=1000 - оценка количества строк которые будут обработаны
width=48 - средний размер строки в байтах

## Как анализировать план в PG

### Типы операций

|                                      |                                         |                     |
| ------------------------------------ | --------------------------------------- | ------------------- |
| Seq Scan                             | Полный перебор                          | плохо               |
| Index Scan                           | Сканирование по индексу                 | Хорошо              |
| Index Only Scan                      | Чтение только из индекса                | Очень хорошо        |
| Bitmap Index Scan + Bitmap Heap Scan | Когда по индексу выбирается много строк | Нормально           |
| Nested Loop, Hash Join, Merge Join   | Типы соединений таблиц                  | зависит от ситуации |

### Стоимость

Формат: `cost=start_cost..total_cost`

-   start_cost - сколько ресурсов нужно чтобы начать получать строки
-   total_cost - сколько ресурсов нужно чтобы получить все строки
    **Меньше total_cost = Лучше**

### Фактическое время

-   actual time - Должно быть в пределах ожиданий
-   Если rows сильно отличается от плана - возможно устарели статистики таблиц

Hash Join - хорошо для больших таблиц, но требует много памяти
Nested Loop - Отлично подходит для маленьких таблиц

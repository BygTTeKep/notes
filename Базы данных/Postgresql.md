# PostgreSQL

Для обеспечения высоко конкурентности pg сохраняет строки реализуя многоверсионное
управление конкурентным доступом или MVCC, который не очень эффективен при изменении данных.
MVCC - позволяет нескольким пользователям одновременно работать с бд.

MVCC - не эффективен для измененния данных, так как он не изменяет строки, а создает новые.
Также существует накопление мертвых строк, когда появляется новая строка, а старую mvcc не удаляет, эти мертвые строки занимают память.
Для борьбы с этим pg использует VACUUM(вакуумирование)

Pg фиксирует все изменения, внесенные в бд каждой транзакцией

## Vacuum

Vacuum - это команда или процесс, предназначенный для очистки и реорганизации бд.
Основной задачей вакуума является управление пространством на диске, удаление мертвых
строк и предотвращение размера бд без необходимости.

## Виды Vacuum

1. Vacuum - удаляет мертвые строки, подчищает индексы, чтобы индексы не ссылались на мертвые строки, **не возращает места на диске**

2) Vacuum full - Используется, в случаях, когда необходимо значительно уменьшить размер таблицы
   на диске. **Блокирует таблицу**
3) Автовакуум - работает в фоновом режиме и автоматически запускается при накоплении определенного
   количесва мертвых строк в таблице. Автовакуум помогает поддерживать таблицу в хорошем
   состоянии без необходимости вручную запускать Vacuum

### autovacuum_truncate

autovacuum_truncate - это параметр в pg, который управляет поведением автоматической очистки(autovacuum)
в отношении освобождения пространства в таблицах после выполнения команды `TRUNCATE`

-   ФУНКЦИЯ: Этот параметр определяет, будет ли автоматический процесс очитски пытаться
    обрезать пустые страницы в конце таблицы после выполнения команды `TRUNCATE`.
    Если включен, autovacuum будет освобождать место, которое стало доступным после TRUNCATE,
    что помогает поддерживать оптимальный размер файлов бд.
-   Параметры: Значение этого параметра может быть установленно на `TRUE` либо `FALSE` и настраиваетсья
    в `posgresql.conf`

Поскольку autovacuum_truncate может запустить команду `TRUNCATE` важно помнить что она(команда TRUNCATE)
блокирует таблицу и все запросы становятся в очередь т.к. используется блокировка ACCESS EXCLUSIVE,из за этого может упасть производительность

## Блокировки

### Пессимистическая блокировка

SELECT ... FOR UPDATE SKIP LOCAKED

## АНАЛИЗ ЗАПРОСОВ

Мониторинг запросов которые выполняются больше 1 секунды
SELECT pid, application_name, age(clock_timestamp(), query_start) AS timing, usename, query
FROM pg_stat_activity
WHERE query <> '' AND state<>'idle' AND age(clock_timestamp(), query_start) > '00:00:01'
ORDER BY age(clock_timestamp(), query_start) desc, application_name, query DESC

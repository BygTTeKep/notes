# MVCC(multiversion concurrency controll)

MVCC - это мультиверсионное управление конкурентным доступом

Основная цели - позволить нескольким пользователям одновременно работать с бд без блокировок друг друго и тупого ожидания

## Как это работает в PG

Когда меняется строка Pg не меняет ее напрямую, вместо этого он создает новую версию строки, а старая версия еще доступна для транзакций, которые ее видели

Каждая строка имеет два специальных скрытых поля:

-   xmin - ID транзации которая создала эту версию строки
-   xmax - ID транзакции которая удалили/изменила ее

И движок БД, когда читает строку, решает: эта версия мне "видна" или нет, в зависимости от того, когда моя транзакция началась.

## Минусы MVCC

1. Рост муссорных данных(При изменении или удалении строки старые версии остаются в таблице до очистки)
2. Требуется VACUUM(Нужно запускать VACUUM для удаление мертвых строк)
3. Потенциальный конфликт версий(При высокой конкуренции запись-запись могут чаще конфликтовать)
4. Рост таблицы = Падение скорости(Если долго не чистить мусор таблицы раздуваются следовательно падает производительность)
5. Большая нагрузка на диск(Больше данных => больше I/o операций на дисках)
6. Долгие транзакции создают проблемы(Пока транзакция открыта, страые версии строк должны хранится, чтобы поддерживать видимость. Если транзакция висит, мусор не удаляется)

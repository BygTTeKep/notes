# Kafka

Kafka - распределённая система обмена сообщениями между серверными приложениями в режиме реального времени / распределенный реплицируемый лог

Главное отличие Kafka от других очередей состоит в том,
как сообщения хранятся на брокере и как потребляются консюмерами

1. Сообщения в kafka не удаляются по мере их обработки консюмерами
2. Благодоря этому одно и тоже сообщение может быть обработанно сколько угодно раз
   разными консюмерами и разных контекстах.
3. Прочитать сообщения можно с определенного места(НАпример когда неправильно
   обработали сообщения, можем сдвинуться назад и вычитать еще раз)

## Структура данных

Каждое сообщение в Kafka состоит из

1. ключа
2. значения
3. таймстампа
4. опционального набора метаданных

Сообщения в Kafka организованны и хранятся в именнованых топиках,
каждый топик хранится в одной или более партиций, распределенных между брокерами
внутри одного кластера.
Когда новое сообщение добавляется в топик на самом деле оно записывается в одну
из партиций топика.
Сообщения с одинаковыми ключами всегда записываются в одну и туже партицию,
тем самым гарантируя очередность или порядок записи и чтения.
Для гарантии сохраности данных каждая партиция может быть реплицирована n раз
где n - replication factor. Таким образом гарантируется наличие нескольких
копий сообщения, хранящихся на разных брокерах.

Основная структура данных Kafka - это распределенный реплицированный лог.
Каждая партиция это и есть тот самый реплицированый лог, который хранится на диске.
Каждое новое сообщение отправленное продюсером в партицию, сохраняется в "голову"
этого лога и получает уникальный монотонно возрастающий offset(64 битное число).

Время гарантированного хранения данных на брокере можно контролировать
с помощью специальной насройки. Длительность хранения сообщения, при этом, не влияет на общую производительность системы.

## Consumer groups

Каждый консюмер kafka обычно является частью какойнибудь консюмер группы.
Каждая группа имеет уникальное название и регестрируется брокерами в кластере kafka.
Данные из одного и того же топика могут считываться множеством консюмер групп одновременно.
Когда несколько консюмеров читают данные из kafka и являются членами одной и тойже
консюмер группы, то каждый их них получает сообщение из разных партиций,
таким образом распределяя нагрузку.

## Гарантии доставки

1. At most once(не более одного раза) - применяется когда важна производительность и допустимы **потери**.
   Продюсер отправляет сообщение и не дожидается подтверждения(ack) от брокера
2. At least once(хотябы один раз) - применяется когда важно чтобы событие было доставленно даже если это приведет к **дублированию**.
   Чтобы обеспечить гарантии доставки нужны ретраи. Продюсер дожидается пожтверждения(ack) от брокера
3. Exactly once(только один раз) - Применяется когда критична доставка и недопустимы дублирования.
   Транзакции кафки гарантируют доставку.
   В техническом плане самый сложный уровень, может не гарантироваться на самом брокере

## Метод send в библиотеках

Метод send отправляет сообщения не в брокер напрямую, а в буфер RecordAccumulation.
Буффер управляется на уровне продюсера и находится в памяти приложения.
Это сделанно для того чтобы отправлять сообщения в кафка покетно, чтобы уменьшить сетевые расходы.
kafka бысрая потомучто когда мы отправляем события они накапливаюстя в буффер и отправляются.

### Буффер отправки (настройки)

Linger.Ms - как долго продюсер ждет отправки пакета
Batch.size - размер пакета сообщений в байтах для оптравки. Если достигнут, то отправка выполняется раньше чем Linger.ms
Buffer.memory - размер буфера. Если буффер переполнится send будет блокироваться до освобождения
